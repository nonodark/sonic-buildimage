From 223ac7ed19e0b73b38c551797c42eb3892d1503d Mon Sep 17 00:00:00 2001
From: xuliping <xuliping@microsoft.com>
Date: Fri, 8 Mar 2024 05:57:17 +0000
Subject: [PATCH] update patch

---
 bgpd/bgp_route.c      |  6 +++---
 bgpd/bgp_updgrp_adv.c | 23 ++++++++++++++---------
 2 files changed, 17 insertions(+), 12 deletions(-)

diff --git a/bgpd/bgp_route.c b/bgpd/bgp_route.c
index 55db3fc7a..f7219ce94 100644
--- a/bgpd/bgp_route.c
+++ b/bgpd/bgp_route.c
@@ -2921,11 +2921,11 @@ void subgroup_process_announce_selected(struct update_subgroup *subgrp,
 					struct attr *adv_attr =
 						bgp_attr_intern(&attr);
 
-					if (!bgp_adj_out_set_subgroup(dest,
+					bgp_adj_out_set_subgroup(dest,
 								      subgrp,
 								      adv_attr,
-								      selected))
-						bgp_attr_unintern(&adv_attr);
+								      selected);
+					bgp_attr_unintern(&adv_attr);
 				} else {
 					bgp_adj_out_unset_subgroup(
 						dest, subgrp, 1, addpath_tx_id);
diff --git a/bgpd/bgp_updgrp_adv.c b/bgpd/bgp_updgrp_adv.c
index 364454e06..cc62548f6 100644
--- a/bgpd/bgp_updgrp_adv.c
+++ b/bgpd/bgp_updgrp_adv.c
@@ -670,7 +670,7 @@ void subgroup_announce_table(struct update_subgroup *subgrp,
 {
 	struct bgp_dest *dest;
 	struct bgp_path_info *ri;
-	struct attr attr;
+	struct attr attr = {0};
 	struct peer *peer;
 	afi_t afi;
 	safi_t safi;
@@ -721,19 +721,24 @@ void subgroup_announce_table(struct update_subgroup *subgrp,
 						struct attr *adv_attr =
 							bgp_attr_intern(&attr);
 
-						if (!bgp_adj_out_set_subgroup(
+						bgp_adj_out_set_subgroup(
 							dest, subgrp, adv_attr,
-							ri))
-							bgp_attr_unintern(&adv_attr);
-					} else
+							ri);
+						bgp_attr_unintern(&adv_attr);
+					} else {
 						bgp_adj_out_unset_subgroup(
 							dest, subgrp, 1,
 							bgp_addpath_id_for_peer(
 								peer, afi,
 								safi_rib,
 								&ri->tx_addpath));
+						bgp_attr_flush(&attr);
+					}
+				} else {
+					bgp_attr_flush(&attr);
 				}
 			} else {
+				bgp_attr_flush(&attr);
 				/* If default originate is enabled for
 				 * the peer, do not send explicit
 				 * withdraw. This will prevent deletion
@@ -963,11 +968,11 @@ void subgroup_default_originate(struct update_subgroup *subgrp, int withdraw)
 					struct attr *default_attr =
 						bgp_attr_intern(&attr);
 
-					if (!bgp_adj_out_set_subgroup(
+					bgp_adj_out_set_subgroup(
 						    dest, subgrp, default_attr,
-						    pi))
-						bgp_attr_unintern(
-							&default_attr);
+						    pi);
+					bgp_attr_unintern(
+						&default_attr);
 				} else
 					bgp_attr_flush(&attr);
 			}
-- 
2.25.1

